# ⚙️ ライセンス管理システム

Google Apps Script (GAS) とスプレッドシートを使用したライセンス認証システムです。

---

## 📋 目次

1. [システム概要](#システム概要)
2. [セットアップ手順](#セットアップ手順)
3. [管理方法](#管理方法)
4. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

### フロー図

```
┌──────────────────┐
│   ユーザー登録    │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ スプレッドシートに │
│   自動記録        │
└────────┬─────────┘
         ↓
┌──────────────────┐
│  管理者が承認     │
│  (ライセンス=ON)  │
└────────┬─────────┘
         ↓
┌──────────────────┐
│  システム利用可能  │
└──────────────────┘
```

### 特徴

- ✅ ユーザー登録時に自動でスプレッドシートに記録
- ✅ 管理者が手動でライセンスを承認
- ✅ リアルタイムでライセンス状態を確認
- ✅ 簡単にライセンスの付与/取消が可能

---

## セットアップ手順

### 1. スプレッドシートの作成

1. [Google スプレッドシート](https://sheets.google.com)で新規作成
2. 名前を設定（例：「AutoTrader ユーザー管理」）

### 2. Google Apps Scriptの作成

1. スプレッドシートで「拡張機能」→「Apps Script」
2. プロジェクト名を設定（例：「AutoTrader License Manager」）
3. `gas/LicenseManager.gs`の内容を貼り付け
4. 保存（Ctrl+S）

### 3. 初期設定の実行

1. 関数選択で`initialSetup`を選択
2. 「実行」をクリック
3. 初回は承認が必要：
   - 「権限を確認」→ アカウント選択
   - 「詳細」→「（安全ではないページ）に移動」
   - 「許可」をクリック
4. **表示されたAPIシークレットをメモ**

### 4. ウェブアプリとしてデプロイ

1. 「デプロイ」→「新しいデプロイ」
2. 種類：「⚙ ウェブアプリ」を選択
3. 設定：
   - 説明：「License Management API」
   - 実行するユーザー：「自分」
   - アクセス権限：「全員」
4. 「デプロイ」をクリック
5. **ウェブアプリURLをコピー**

### 5. 環境変数の設定

`.env`ファイルに追加：

```env
GAS_WEBHOOK_URL=https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
GAS_API_SECRET=your_gas_api_secret_here
```

---

## 管理方法

### スプレッドシートの構造

| No. | メールアドレス | ユーザーID | 登録日時 | ライセンス | 承認日時 | メモ |
|:----|:--------------|:-----------|:---------|:-----------|:---------|:-----|
| 1 | user@example.com | 64a1b2c3... | 2024-01-01T09:00:00Z | OFF | | |

### ライセンス承認方法

#### 方法1: 直接編集

1. スプレッドシートを開く
2. 「ライセンス」列（E列）を`OFF`→`ON`に変更

#### 方法2: メニューから操作

1. 対象行を選択（複数可）
2. メニュー「ライセンス管理」→「選択行のライセンスをONにする」

### ライセンスの取り消し

- 「ライセンス」列を`ON`→`OFF`に変更
- または「ライセンス管理」→「選択行のライセンスをOFFにする」

---

## ユーザー側の動作

### 登録直後

「ライセンス承認待ち」画面が表示されます。

### 承認後

- 30秒ごとに自動確認
- または「ライセンス状態を確認」ボタンで即時確認
- 承認後はダッシュボードにアクセス可能

---

## GASの更新方法

スクリプトを更新した場合：

1. 「デプロイ」→「デプロイを管理」
2. 右上の「✏ 編集」アイコン
3. バージョン：「新しいバージョン」
4. 「デプロイ」

> ⚠️ URLは変わりませんが、再デプロイが必要です

---

## トラブルシューティング

### 「License service not configured」エラー

**原因:** 環境変数が設定されていない

**解決:**
1. `.env`に`GAS_WEBHOOK_URL`と`GAS_API_SECRET`があるか確認
2. サーバーを再起動

### スプレッドシートに登録されない

**確認事項:**
1. GASのデプロイが正しく行われているか
2. ウェブアプリURLが正しいか
3. APIシークレットが一致しているか
4. GASの実行ログを確認（Apps Script→実行→履歴）

### ライセンスがONなのにログインできない

**解決:**
1. 「ライセンス状態を確認」ボタンをクリック
2. または再ログイン
3. スプレッドシートの値が正確に`ON`（大文字）か確認

### GASの実行エラー

**確認方法:**
1. Apps Scriptエディタを開く
2. 「実行」→「履歴」
3. エラーログを確認

---

## セキュリティ考慮事項

1. **APIシークレットの管理**
   - シークレットは安全に保管
   - 定期的にローテーション

2. **アクセス制限**
   - GASへのアクセスを制限（必要に応じて）
   - スプレッドシートの共有設定を確認

3. **監査ログ**
   - ライセンス変更時の承認日時が自動記録
   - 定期的に確認

---

## 次のステップ

- [📘 セットアップガイド](SETUP.md) - システムの設定
- [🔑 取引所API設定](EXCHANGES.md) - APIキーの設定
